Bootstrap: docker
From: ghcr.io/quarto-dev/quarto-full:1.8.21

%labels
    Author "Your Name"
    Description "VS code server with R, Python, Jupyter, Quarto"

%post
    export DEBIAN_FRONTEND=noninteractive
    
    # Install additional system deps that might not be in quarto-full
    apt-get update
    apt-get install -y git


    mkdir -p /opt/bin
    export PATH="/opt/bin:$PATH"

    export XDG_BIN_HOME=/opt/bin
    export XDG_DATA_HOME=/opt/share
    export XDG_CACHE_HOME=/opt/cache

    # add UV
    curl -LsSf https://astral.sh/uv/install.sh | sh

    # Install VS Code CLI (code command)
    curl -Lk 'https://code.visualstudio.com/sha/download?build=stable&os=cli-alpine-x64' --output vscode_cli.tar.gz
    tar -xf vscode_cli.tar.gz
    mv code /opt/bin
    chmod +x /opt/bin/code
    rm vscode_cli.tar.gz

%environment
    # Point caches to persistent scratch dirs (bind these at runtime)
    export UV_CACHE_DIR=/fh/fast/_IRC/FHIL/grp/bioinfo_tools/package_caches/uv/
    export RENV_PATHS_CACHE=/fh/fast/_IRC/FHIL/grp/bioinfo_tools/package_caches/renv/
    
    export JUPYTER_DATA_DIR=/tmp/jupyter_data
    export JUPYTER_CONFIG_DIR=/tmp/jupyter_config
    export IPYTHONDIR=/tmp/ipython

    # Set relevant Cross Desktop Group settings
    # Set XDG_BIN_HOME to a proper system location
    export XDG_BIN_HOME=/tmp/bin
    export XDG_DATA_HOME=/tmp/share
    export XDG_CACHE_HOME=/tmp/cache

    export PATH="/opt/bin:$PATH"


    # Ensure installs are in path
    export PATH=/usr/local/bin:$PATH
    
    # VS Code and code-server settings
    export CS_DISABLE_GETTING_STARTED_OVERRIDE=1

%runscript
    if [ $# -eq 0 ]; then
        exec code tunnel
    else
        exec "$@"
    fi
